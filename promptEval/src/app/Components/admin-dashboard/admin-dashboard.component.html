<div class="mx-auto max-w-[1200px] px-4 py-6">

    <!-- KPIs -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div *ngFor="let k of kpis" class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
            <div class="flex items-center justify-between">
                <div class="text-sm text-gray-500">{{ k.label }}</div>
                <ng-container [ngSwitch]="k.icon">
                    <svg *ngSwitchCase="'users'" class="h-5 w-5 text-blue-600" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5C15 14.17 10.33 13 8 13zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.96 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
                    </svg>
                    <svg *ngSwitchCase="'new'" class="h-5 w-5 text-blue-600" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2 8 8h8z" />
                        <path d="M12 22 8 16h8z" />
                        <path d="M2 12l6-4v8zM22 12l-6 4V8z" />
                    </svg>
                    <svg *ngSwitchCase="'retention'" class="h-5 w-5 text-blue-600" viewBox="0 0 24 24"
                        fill="currentColor">
                        <path d="M12 8v5l4 2" />
                        <path d="M21 12A9 9 0 1 1 12 3a9 9 0 0 1 9 9z" />
                    </svg>
                    <svg *ngSwitchDefault class="h-5 w-5 text-blue-600" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 8v5l4 2" />
                        <path d="M21 12A9 9 0 1 1 12 3a9 9 0 0 1 9 9z" />
                    </svg>
                </ng-container>
            </div>
            <div class="mt-2 text-2xl font-semibold text-gray-900">{{ k.value }}</div>
            <div class="mt-1 text-xs">
                <span [ngClass]="deltaClass(k.delta)" class="font-medium">{{ deltaPrefix(k.delta) }}{{ k.delta.value
                    }}%</span>
            </div>
        </div>
    </div>

    <!-- Charts row -->
    <div class="mt-5 grid grid-cols-1 lg:grid-cols-2 gap-4">
        <!-- ML Model Performance -->
        <div class="rounded-xl border border-gray-200 bg-white p-4">
            <div class="mb-3 font-semibold text-gray-900">ML Model Performance</div>
            <svg [attr.width]="modelPerf.w" [attr.height]="modelPerf.h" class="block">
                <!-- frame -->
                <rect [attr.x]="modelPerf.pad" [attr.y]="modelPerf.pad" [attr.width]="modelPerf.w - modelPerf.pad*2"
                    [attr.height]="modelPerf.h - modelPerf.pad*2" rx="6" fill="none" stroke="#E5E7EB" stroke-width="1">
                </rect>

                <!-- series -->
                <path *ngFor="let s of modelPerf.series"
                    [attr.d]="linePath(s.values, modelPerf.max, modelPerf.w, modelPerf.h, modelPerf.pad)" fill="none"
                    [attr.stroke]="s.color" stroke-width="2"></path>

                <!-- x labels -->
                <g *ngFor="let l of modelPerf.labels; index as i">
                    <text [attr.x]="xTick(i, modelPerf.labels.length, modelPerf.w, modelPerf.pad)"
                        [attr.y]="modelPerf.h - 6" text-anchor="middle" class="text-[11px] fill-gray-500 select-none">{{
                        l }}</text>
                </g>

                <!-- legend -->
                <g transform="translate(8,10)">
                    <ng-container *ngFor="let s of modelPerf.series; index as i">
                        <rect [attr.x]="i*70" y="0" width="10" height="10" [attr.fill]="s.color" rx="2"></rect>
                        <text [attr.x]="i*70 + 14" y="9" class="text-[11px] fill-gray-600">{{ s.name }}</text>
                    </ng-container>
                </g>
            </svg>
        </div>

        <!-- User Activity -->
        <div class="rounded-xl border border-gray-200 bg-white p-4">
            <div class="mb-3 font-semibold text-gray-900">User Activity</div>
            <svg [attr.width]="activity.w" [attr.height]="activity.h" class="block">
                <!-- frame -->
                <rect [attr.x]="activity.pad" [attr.y]="activity.pad" [attr.width]="activity.w - activity.pad*2"
                    [attr.height]="activity.h - activity.pad*2" rx="6" fill="none" stroke="#E5E7EB" stroke-width="1">
                </rect>

                <!-- bars -->
                <g>
                    <ng-container *ngFor="let v of activity.values; index as i">
                        <ng-container>
                            <ng-container>
                                <rect
                                    [attr.x]="activity.pad + (i * ((activity.w - activity.pad*2) / activity.values.length)) + 8"
                                    [attr.y]="activity.pad + (activity.h - activity.pad*2) - (v/activity.max) * (activity.h - activity.pad*2)"
                                    width="24" [attr.height]="(v/activity.max) * (activity.h - activity.pad*2)"
                                    [attr.fill]="activity.color" rx="4"></rect>
                                <text
                                    [attr.x]="activity.pad + (i * ((activity.w - activity.pad*2) / activity.values.length)) + 20"
                                    [attr.y]="activity.h - 6" text-anchor="middle"
                                    class="text-[11px] fill-gray-500 select-none">{{ activity.labels[i] }}</text>
                            </ng-container>
                        </ng-container>
                    </ng-container>
                </g>
            </svg>
        </div>
    </div>

    <!-- Middle row: Donut / Stats / Health -->
    <div class="mt-5 grid grid-cols-1 lg:grid-cols-3 gap-4">
        <!-- Demographics -->
        <div class="rounded-xl border border-gray-200 bg-white p-4">
            <div class="mb-3 font-semibold text-gray-900">User Demographics</div>
            <div class="flex items-center gap-6">
                <svg [attr.width]="(demographics.radius+demographics.stroke)*2"
                    [attr.height]="(demographics.radius+demographics.stroke)*2" class="block">
                    <g
                        [attr.transform]="'translate(' + (demographics.radius+demographics.stroke) + ',' + (demographics.radius+demographics.stroke) + ')'">
                        <ng-container *ngFor="let s of demographics.slices; index as i">
                            <circle [attr.r]="demographics.radius" [attr.stroke-width]="demographics.stroke"
                                [attr.stroke]="s.color" fill="none" [attr.stroke-dasharray]="donutDasharrayFor(i)"
                                [attr.stroke-dashoffset]="donutDashoffsetFor(i)" stroke-linecap="round"
                                transform="rotate(-90)">
                            </circle>
                        </ng-container>
                        <text text-anchor="middle" dy="6" class="text-sm fill-gray-700">{{ donutTotal() }}%</text>
                    </g>
                </svg>

                <div class="space-y-2">
                    <div *ngFor="let s of demographics.slices" class="flex items-center gap-2 text-sm">
                        <span class="inline-block h-2.5 w-2.5 rounded-sm" [style.background]="s.color"></span>
                        <span class="text-gray-700">{{ s.label }}</span>
                        <span class="ml-auto font-medium text-gray-900">{{ s.value }}%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Prompt Analysis -->
        <div class="rounded-xl border border-gray-200 bg-white p-4">
            <div class="mb-3 font-semibold text-gray-900">Prompt Analysis</div>
            <div class="grid grid-cols-2 gap-3">
                <div *ngFor="let st of promptStats" class="rounded-lg border border-gray-200 p-3">
                    <div class="text-xs text-gray-500">{{ st.label }}</div>
                    <div class="mt-1 text-lg font-semibold text-gray-900">{{ st.value }}</div>
                </div>
            </div>
        </div>

        <!-- System Health -->
        <div class="rounded-xl border border-gray-200 bg-white p-4">
            <div class="mb-3 font-semibold text-gray-900">System Health</div>
            <div class="space-y-2">
                <div *ngFor="let h of systemHealth"
                    class="flex items-center justify-between rounded-lg border border-gray-200 p-3">
                    <div class="text-sm text-gray-700">{{ h.label }}</div>
                    <span class="text-sm font-medium" [ngClass]="{
                  'text-emerald-600': h.status === 'Operational',
                  'text-orange-600': h.status === 'Warning',
                  'text-red-600': h.status === 'Degraded' || h.status === 'Down'
                }">
                        {{ h.status }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- User Data table -->
    <div class="mt-5 rounded-xl border border-gray-200 bg-white p-4">
        <div class="mb-3 font-semibold text-gray-900">User Data</div>
        <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
                <thead class="text-left text-gray-500">
                    <tr>
                        <th class="py-2 pr-4">ID</th>
                        <th class="py-2 pr-4">Name</th>
                        <th class="py-2 pr-4">Join Date</th>
                        <th class="py-2 pr-4">Last Active</th>
                        <th class="py-2 pr-4">Prompts</th>
                        <th class="py-2 pr-4">Avg Score</th>
                        <th class="py-2">Plan</th>
                    </tr>
                </thead>
                <tbody class="text-gray-800">
                    <tr *ngFor="let u of users" class="border-t border-gray-100">
                        <td class="py-2 pr-4 tabular-nums">{{ u.id }}</td>
                        <td class="py-2 pr-4 flex items-center gap-2">
                            <span
                                class="inline-flex h-7 w-7 items-center justify-center rounded-full bg-gray-100 text-[11px] font-semibold">
                                {{ initials(u.name) }}
                            </span>
                            {{ u.name }}
                        </td>
                        <td class="py-2 pr-4">{{ u.joined }}</td>
                        <td class="py-2 pr-4">{{ u.lastActive }}</td>
                        <td class="py-2 pr-4 tabular-nums">{{ u.prompts }}</td>
                        <td class="py-2 pr-4 tabular-nums">{{ u.avgScore }}</td>
                        <td class="py-2">{{ u.plan }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

</div>