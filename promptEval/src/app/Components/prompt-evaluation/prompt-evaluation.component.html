<div class="relative w-full min-h-screen bg-gray-50">

    <div class="w-full max-w-[1100px] mx-auto px-4 py-5">
        <!-- Page Header -->
        <div class="mb-4">
            <h1 class="font-semibold text-gray-900 text-2xl tracking-tight mb-1">
                Prompt Evaluation
            </h1>
            <p class="text-[15px] text-gray-600 leading-[1.35]">
                Analyze and improve your prompts with AI-powered feedback
            </p>
        </div>

        <!-- Choose Template Button -->
        <div class="flex justify-end mb-4">
            <!-- Domain -->
            <label class="block md:col-span-1">
                <button (click)="toggleForms()"
                    class="inline-flex h-9 items-center justify-center px-4 bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1">
                    <span class="font-medium text-white text-[14px] leading-none">Toggle Forms</span>
                </button>
            </label>
        </div>

        <!--Prompt input the large input box-->
        <section *ngIf="!showForm1" class="mb-4" aria-labelledby="prompt-input-1-heading">
            <div class="bg-white rounded-lg border border-gray-200 p-4 mb-3">
                <label class="block md:col-span-3">
                    <span>Input Prompt</span>
                    <textarea [(ngModel)]="promptText" class="w-full mt-1 px-2 py-2 border rounded resize-y h-50"
                        placeholder="Input the prompt">
                    </textarea>
                </label>
            </div>
        </section>

        <!-- Prompt Input (detailed, domain-specific) -->
        <section *ngIf="showForm1" ngClass="detailedInput" class="mb-4" aria-labelledby="prompt-input-heading">
            <div class="bg-white rounded-lg border border-gray-200 p-4 mb-3">
                <h3 class="font-medium text-gray-900 mb-3">Build a detailed prompt (choose domain + specifics)</h3>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <!-- Domain -->
                    <label class="block md:col-span-1">
                        <span class="text-sm text-gray-700">Domain</span>
                        <select [(ngModel)]="form.domain" class="w-full mt-1 px-2 py-2 border rounded">
                            <option value="software_engineering">Software engineering</option>
                            <option value="content_creation">Content creation</option>
                            <option value="education">Education</option>
                        </select>
                    </label>

                    <!-- Subtype / What to create -->
                    <label class="block md:col-span-2">
                        <span class="text-sm text-gray-700">What do you want to create? (choose one)</span>
                        <select [(ngModel)]="form.subtype" class="w-full mt-1 px-2 py-2 border rounded">
                            <!-- software engineering -->
                            <optgroup label="Software engineering" *ngIf="form.domain==='software_engineering'">
                                <option value="full_stack_app">Full-stack application</option>
                                <option value="backend_api">Backend API / microservice</option>
                                <option value="cli_tool">CLI tool/script</option>
                                <option value="unit_tests">Unit tests / test plan</option>
                                <option value="refactor_plan">Refactor plan / architecture notes</option>
                            </optgroup>

                            <!-- content creation -->
                            <optgroup label="Content creation" *ngIf="form.domain==='content_creation'">
                                <option value="blog_post">Blog post / article</option>
                                <option value="social_post_series">Social media post series</option>
                                <option value="video_script">Video script</option>
                                <option value="newsletter">Newsletter issue</option>
                            </optgroup>

                            <!-- education -->
                            <optgroup label="Education" *ngIf="form.domain==='education'">
                                <option value="lesson_plan">Lesson plan</option>
                                <option value="quiz">Quiz & answer key</option>
                                <option value="summary">Topic summary</option>
                                <option value="exercise_set">Exercise set with solutions</option>
                            </optgroup>
                        </select>
                    </label>

                    <!-- Title / short description -->
                    <label class="block md:col-span-3">
                        <span class="text-sm text-gray-700">Title / Short description</span>
                        <input [(ngModel)]="form.title"
                            placeholder="E.g. 'Notes app with auth' or 'Intro to photosynthesis lesson'"
                            class="w-full mt-1 px-2 py-2 border rounded" />
                    </label>

                    <!-- Audience & Purpose -->
                    <label class="block md:col-span-1">
                        <span class="text-sm text-gray-700">Target audience</span>
                        <input [(ngModel)]="form.audience"
                            placeholder="e.g. junior devs, high school students, general readers"
                            class="w-full mt-1 px-2 py-2 border rounded" />
                    </label>

                    <label class="block md:col-span-2">
                        <span class="text-sm text-gray-700">Purpose / goal</span>
                        <input [(ngModel)]="form.purpose"
                            placeholder="What should this output achieve? (educate, sell, prototype...)"
                            class="w-full mt-1 px-2 py-2 border rounded" />
                    </label>

                    <!-- Required sections / key points -->
                    <label class="block md:col-span-3">
                        <span class="text-sm text-gray-700">Required sections / key points (comma separated)</span>
                        <input [(ngModel)]="form.keyPoints" placeholder="e.g. authentication, JWT, CRUD endpoints"
                            class="w-full mt-1 px-2 py-2 border rounded" />
                    </label>

                    <!-- Output format / schema -->
                    <label class="block md:col-span-3">
                        <span class="text-sm text-gray-700">Desired output format / schema</span>
                        <select [(ngModel)]="form.outputFormat" class="w-full mt-1 px-2 py-2 border rounded">
                            <option value="plain">Plain text</option>
                            <option value="markdown">Markdown</option>
                            <option value="json">JSON (structured)</option>
                            <option value="html">HTML</option>
                            <option value="code">Source code</option>
                        </select>
                        <small class="text-xs text-gray-500">If JSON, describe required keys in "Acceptance criteria"
                            below.</small>
                    </label>

                    <!-- Tech stack / language -->
                    <label class="block md:col-span-1">
                        <span class="text-sm text-gray-700">Tech / language</span>
                        <input [(ngModel)]="form.tech" placeholder="e.g. Node.js, Python, React, or 'N/A'"
                            class="w-full mt-1 px-2 py-2 border rounded" />
                    </label>

                    <!-- Length and quality -->
                    <label class="block md:col-span-1">
                        <span class="text-sm text-gray-700">Length target</span>
                        <input [(ngModel)]="form.lengthTarget" placeholder="e.g. 300 words, 12â€“20 lines, or N/A"
                            class="w-full mt-1 px-2 py-2 border rounded" />
                    </label>

                    <label class="block md:col-span-1">
                        <span class="text-sm text-gray-700">Tone / style</span>
                        <select [(ngModel)]="form.tone" class="w-full mt-1 px-2 py-2 border rounded">
                            <option value="neutral">Neutral</option>
                            <option value="formal">Formal</option>
                            <option value="casual">Casual</option>
                            <option value="technical">Technical</option>
                            <option value="persuasive">Persuasive</option>
                        </select>
                    </label>

                    <!-- Example input -->
                    <label class="block md:col-span-3">
                        <span class="text-sm text-gray-700">Example / sample input (optional)</span>
                        <textarea [(ngModel)]="form.example"
                            placeholder="Optional: example data, example user story, or sample input"
                            class="w-full mt-1 px-2 py-2 border rounded resize-y h-20"></textarea>
                    </label>

                    <!-- Acceptance criteria -->
                    <label class="block md:col-span-3">
                        <span class="text-sm text-gray-700">Acceptance criteria (what must be present for
                            success)</span>
                        <textarea [(ngModel)]="form.acceptance"
                            placeholder="Explicit checklist: e.g. must include endpoints: /login, /register; must validate email; output as JSON with keys: title, body"
                            class="w-full mt-1 px-2 py-2 border rounded resize-y h-24"></textarea>
                        <small class="text-xs text-gray-500">This is used by the automatic validator to decide
                            pass/fail.</small>
                    </label>

                    <!-- Constraints -->
                    <label class="block md:col-span-3">
                        <span class="text-sm text-gray-700">Additional constraints / notes</span>
                        <textarea [(ngModel)]="form.constraints"
                            placeholder="Other constraints: licensing, libraries to avoid, plagiarism check, safety notes..."
                            class="w-full mt-1 px-2 py-2 border rounded resize-y h-20"></textarea>
                    </label>
                </div>


            </div>
        </section>

        <!-- Action buttons -->
        <div class="flex items-center justify-end gap-2 mt-3">
            <button (click)="assemblePromptAndEvaluate()"
                class="inline-flex h-9 items-center justify-center px-4 bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1">
                <span class="font-medium text-white text-[14px] leading-none">Generate & Evaluate</span>
            </button>

            <button (click)="resetForm()"
                class="inline-flex h-9 items-center justify-center px-4 rounded-md border border-gray-200 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-1">
                <span class="text-[14px] text-gray-700 leading-none">Reset</span>
            </button>
        </div>



        <!-- Results -->
        <section class="mb-4 grid grid-cols-1 lg:grid-cols-3 gap-4" aria-labelledby="evaluation-results-heading">
            <!-- Original Prompt -->
            <article class="lg:col-span-2 bg-white rounded-lg border border-gray-200 p-4">
                <h2 class="font-semibold text-gray-900 text-[18px] leading-[1.3] mb-3">Original Prompt</h2>

                <div class="mb-3">
                    <div class="mb-2">
                        <p class="text-[15px] text-gray-800 leading-[1.35] overflow-hidden">
                            {{promptText || 'Enter your prompt in the provided section above'}}
                        </p>
                    </div>

                    <div class="space-y-1.5">
                        <div class="flex items-start gap-1.5" *ngFor="let suggestion of suggestions">
                            <svg class="w-4 h-4 text-gray-500 mt-[2px]" viewBox="0 0 16 15" fill="currentColor">
                                <path d="M8 1L10 5H14L11 8L12 12L8 10L4 12L5 8L2 5H6L8 1Z" />
                            </svg>
                            <p class="text-[14px] text-gray-600 leading-snug">{{ suggestion.text }}</p>
                        </div>
                    </div>
                </div>
            </article>

            <!-- Scoring Metrics Explanation -->
            <aside class="bg-white rounded-lg border border-gray-200 p-4 mb-4">
                <h2 class="font-semibold text-gray-900 text-[18px] leading-[1.3] mb-3">Scoring Metrics Explained</h2>
                <ul class="list-disc pl-5 space-y-1 text-gray-700 text-[14px]">
                    <li><strong>Clarity:</strong> How clearly the prompt communicates its task and intent.</li>
                    <li><strong>Context:</strong> How well the prompt provides necessary context to understand the task.
                    </li>
                    <li><strong>Relevance:</strong> How appropriate and aligned the prompt is for the intended task.
                    </li>
                    <li><strong>Specificity:</strong> How detailed and unambiguous the instructions are.</li>
                    <li><strong>Creativity:</strong> How original, innovative, or engaging the prompt is.</li>
                </ul>
            </aside>


            <!-- Scores -->
            <aside class="bg-white rounded-lg border border-gray-200 p-4">
                <h2 class="font-semibold text-gray-900 text-[18px] leading-[1.3] mb-3">Evaluation Scores</h2>

                <div class="space-y-3">
                    <div class="flex items-center justify-between" *ngFor="let score of evaluationScores">
                        <span class="text-[15px] text-gray-600 leading-[1.35]">{{ score.label }}</span>
                        <div class="flex items-center gap-2">
                            <span [class]="'font-semibold text-[15px] leading-none ' + score.color">{{ score.score
                                }}</span>
                            <div class="w-[88px] h-3 bg-gray-200 rounded-full overflow-hidden">
                                <div [class]="'h-3 rounded-full transition-all duration-300 ' + getScoreBarColor(score.score)"
                                    [style.width.%]="getScorePercentage(score.score)"></div>
                            </div>
                        </div>
                    </div>

                    <div class="border-t border-gray-200 pt-3">
                        <div class="flex items-center justify-between">
                            <span class="font-semibold text-gray-900 text-[15px] leading-none">Overall Score</span>
                            <div class="flex items-center gap-2">
                                <span class="font-semibold text-blue-600 text-[15px] leading-none">{{overallScore ??
                                    0}}</span>
                                <div class="w-[88px] h-3 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-3 rounded-full bg-blue-500 transition-all duration-300"
                                        style="width: 76%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>
        </section>
        <!-- Suggested Rewrites -->
        <section class="mb-5" aria-labelledby="suggested-rewrites-heading">
            <h2 class="font-semibold text-gray-900 text-[18px] leading-[1.3] mb-4">Suggested Rewrites</h2>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                <article *ngFor="let version of rewriteVersions; let i = index"
                    class="bg-white rounded-lg border border-gray-200 p-4 flex flex-col h-[360px]">
                    <h3 class="font-semibold text-gray-900 text-[15px] leading-[1.3] mb-3">{{ version.title }}</h3>

                    <div class="flex-1 mb-3">
                        <p
                            [class]="'text-[15px] text-gray-600 leading-[1.35] overflow-hidden ' + (i === 2 ? 'line-clamp-6' : 'line-clamp-7')">
                            {{ version.content }}
                        </p>
                    </div>

                    <div class="space-y-1.5 mb-3">
                        <div class="flex items-center gap-2" *ngFor="let improvement of version.improvements">
                            <svg class="w-3.5 h-3.5 text-emerald-500" viewBox="0 0 13 13" fill="currentColor">
                                <path
                                    d="M6.5 1.5L8 4.5L11.5 5L9 7.5L9.5 11L6.5 9.5L3.5 11L4 7.5L1.5 5L5 4.5L6.5 1.5Z" />
                            </svg>
                            <span class="text-[14px] text-gray-600 leading-snug flex-1">{{ improvement.text }}</span>
                        </div>
                    </div>

                    <button (click)="handleApplyRewrite(version)"
                        class="w-full h-[38px] flex items-center justify-center px-3 rounded-md border border-blue-600 hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1">
                        <span class="font-medium text-blue-600 text-[14px] leading-none">Apply</span>
                    </button>
                </article>
            </div>
        </section>

        <div class="actions">
            <button class="btn bg-blue-600 rounded px-2 text-amber-50 mb-0.5 btn-outline-secondary ms-2"
                (click)="openTrace()" [disabled]="!lastTraceId">
                View Trace
            </button>

        </div>

        <!-- Optional helper text -->
        <div class="text-muted small mt-1" *ngIf="lastTraceId">
            Last trace ID: {{ lastTraceId }}
        </div>


        <!-- Footer Actions -->
        <footer class="flex flex-col sm:flex-row items-center justify-between gap-3 pt-4 border-t border-gray-200">
            <div class="flex items-center gap-3">
                <button (click)="handleRevise()"
                    class="inline-flex h-9 items-center justify-center px-4 bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1">
                    <span class="font-medium text-white text-[14px] leading-none">Revise</span>
                </button>
                <button (click)="handleSubmitOriginal()"
                    class="inline-flex h-9 items-center justify-center px-4 rounded-md border border-gray-200 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-1">
                    <span class="text-[14px] text-gray-700 leading-none">Submit Original</span>
                </button>
            </div>

            <button (click)="handleSaveToHistory()"
                class="flex items-center gap-2 px-4 h-9 rounded-md border border-gray-200 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-1">
                <svg class="w-4 h-4 text-gray-500" viewBox="0 0 14 14" fill="currentColor">
                    <path
                        d="M12 1H5C4.5 1 4 1.5 4 2V3H3C2.5 3 2 3.5 2 4V12C2 12.5 2.5 13 3 13H10C10.5 13 11 12.5 11 12V11H12C12.5 11 13 10.5 13 10V2C13 1.5 12.5 1 12 1Z" />
                </svg>
                <span class="text-[14px] text-gray-700 leading-none">Save to History</span>
            </button>
            <button class="ml-2 inline-flex items-center gap-2 px-3 py-1 border rounded"
                (click)="router.navigate(['/prompt-evidence'])">
                View Evidence
            </button>
        </footer>
    </div>
</div>